<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Android Barcode Scanner with QuaggaJS</title>
    <!-- QuaggaJS Library -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/quagga/0.12.1/quagga.min.js"></script>
    <style>
        /* Container styling to maintain 4:3 aspect ratio */
        #scanner-container {
            position: relative;
            width: 100%;
            max-width: 480px; /* Adjust as needed */
            margin: auto;
            padding-top: 75%; /* 4:3 Aspect Ratio (height/width = 0.75) */
            background: #000;
            overflow: hidden;
        }
        /* Overlay canvas positioning */
        #overlay {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none; /* Allow clicks to pass through */
        }
        /* Start Scanner button styling */
        #start-button {
            display: block;
            margin: 20px auto;
            padding: 10px 20px;
            font-size: 16px;
        }
    </style>
</head>
<body>
    <!-- Start Scanner Button -->
    <button id="start-button">Start Scanner</button>

    <!-- Scanner Container with Overlay -->
    <div id="scanner-container">
        <canvas id="overlay"></canvas>
    </div>

    <script>
        // Reference to the Start Scanner button
        const startButton = document.getElementById('start-button');

        // Event listener for the Start Scanner button
        startButton.addEventListener('click', function() {
            // Disable the button to prevent multiple initializations
            startButton.disabled = true;

            // Initialize QuaggaJS
            Quagga.init({
                inputStream: {
                    name: "Live",
                    type: "LiveStream",
                    target: document.querySelector('#scanner-container'), // Use the container div
                    constraints: {
                        facingMode: "environment", // Use rear camera
                        width: { ideal: 640 },
                        height: { ideal: 480 }
                    }
                },
                decoder: {
                    readers: ["upc_reader"] // UPC barcode reader
                },
                locate: true, // Enable localization of barcodes
                area: {
                    top: "0%",    // Top offset
                    right: "0%",  // Right offset
                    left: "0%",   // Left offset
                    bottom: "0%"  // Bottom offset
                },
                debug: {
                    drawBoundingBox: false, // Disable Quagga's bounding box
                    showFrequency: false,
                    drawScanline: false,
                    showPattern: false
                }
            }, function(err) {
                if (err) {
                    console.error(err);
                    alert("Error initializing the scanner.");
                    startButton.disabled = false;
                    return;
                }
                // Start QuaggaJS
                Quagga.start();
            });

            // Event handler when a barcode is detected
            Quagga.onDetected(function(data) {
                const code = data.codeResult.code;
                console.log("Barcode detected: " + code);
                alert("Barcode detected: " + code);
                Quagga.stop(); // Stop the scanner after detection
                startButton.disabled = false; // Re-enable the button
            });

            // Handle processed frames for debugging and overlay
            Quagga.onProcessed(function(result) {
                const overlay = document.getElementById('overlay');
                const context = overlay.getContext('2d');

                if (result) {
                    // Clear previous drawings
                    context.clearRect(0, 0, overlay.width, overlay.height);

                    if (result.boxes) {
                        result.boxes.filter(function(box) {
                            return box !== result.box;
                        }).forEach(function(box) {
                            context.strokeStyle = "#00FF00";
                            context.lineWidth = 2;
                            context.strokeRect(box[0].x, box[0].y, box[2].x - box[0].x, box[2].y - box[0].y);
                        });
                    }

                    if (result.box) {
                        context.strokeStyle = "#FF0000";
                        context.lineWidth = 2;
                        context.strokeRect(result.box[0].x, result.box[0].y, result.box[2].x - result.box[0].x, result.box[2].y - result.box[0].y);
                    }

                    if (result.codeResult && result.codeResult.code) {
                        context.font = "18px Arial";
                        context.fillStyle = "#FF0000";
                        context.fillText(result.codeResult.code, result.box[0].x, result.box[0].y - 10);
                    }
                }
            });

            // Resize the overlay canvas to match the video stream
            function resizeOverlay() {
                const overlay = document.getElementById('overlay');
                const scannerContainer = document.getElementById('scanner-container');
                overlay.width = scannerContainer.clientWidth;
                overlay.height = scannerContainer.clientHeight;
            }

            // Initial resize
            resizeOverlay();

            // Resize on window resize
            window.addEventListener('resize', resizeOverlay);
        });
    </script>
</body>
</html>
