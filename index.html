<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Android Barcode Scanner with QuaggaJS</title>
    <!-- QuaggaJS Library -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/quagga/0.12.1/quagga.min.js"></script>
    <style>
        /* Container styling to maintain 4:3 aspect ratio and center content */
        #scanner-container {
            position: relative;
            width: 100%;
            max-width: 600px; /* Adjust as needed */
            margin: 20px auto;
            padding-top: 75%; /* 4:3 Aspect Ratio (height/width = 0.75) */
            background: #000;
            overflow: hidden;
        }
        /* Video element styling */
        #video {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            object-fit: cover; /* Ensure the video covers the container */
        }
        /* Overlay canvas styling */
        #overlay {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none; /* Allow clicks to pass through */
            z-index: 10; /* Ensure overlay is above video */
        }
        /* Start Scanner button styling */
        #start-button {
            display: block;
            margin: 20px auto;
            padding: 15px 30px;
            font-size: 18px;
            background-color: #4CAF50;
            color: white;
            border: none;
            border-radius: 8px;
            cursor: pointer;
        }
        #start-button:disabled {
            background-color: #888;
            cursor: not-allowed;
        }
        /* Debug message styling */
        #debug-message {
            text-align: center;
            margin-top: 10px;
            font-family: Arial, sans-serif;
            color: #333;
        }
    </style>
</head>
<body>
    <!-- Start Scanner Button -->
    <button id="start-button">Start Scanner</button>

    <!-- Scanner Container with Video and Overlay Canvas -->
    <div id="scanner-container">
        <video id="video" autoplay muted playsinline></video>
        <canvas id="overlay"></canvas>
    </div>

    <!-- Debug Message -->
    <div id="debug-message">Press "Start Scanner" to begin.</div>

    <script>
        // References to DOM elements
        const startButton = document.getElementById('start-button');
        const video = document.getElementById('video');
        const overlay = document.getElementById('overlay');
        const debugMessage = document.getElementById('debug-message');
        const overlayContext = overlay.getContext('2d');

        // Function to resize the overlay canvas to match video dimensions
        function resizeOverlay() {
            overlay.width = video.videoWidth;
            overlay.height = video.videoHeight;
        }

        // Function to draw scan lines (for visual feedback)
        function drawScanLines() {
            const width = overlay.width;
            const height = overlay.height;
            const lineSpacing = 20; // Adjust spacing between lines
            overlayContext.strokeStyle = 'rgba(255, 0, 0, 0.5)';
            overlayContext.lineWidth = 2;

            for (let y = 0; y < height; y += lineSpacing) {
                overlayContext.beginPath();
                overlayContext.moveTo(0, y);
                overlayContext.lineTo(width, y);
                overlayContext.stroke();
            }
        }

        // Function to initialize QuaggaJS
        function initializeQuagga() {
            Quagga.init({
                inputStream: {
                    name: "Live",
                    type: "LiveStream",
                    target: video, // Video element
                    constraints: {
                        facingMode: { exact: "environment" }, // Use rear camera
                        width: { ideal: 1280 }, // Higher resolution
                        height: { ideal: 720 }
                    }
                },
                decoder: {
                    readers: [
                        "upc_reader",       // UPC-A, UPC-E
                        "ean_reader",       // EAN-13, EAN-8
                        "code_128_reader",  // Code 128
                        "code_39_reader",   // Code 39
                        "code_93_reader",   // Code 93
                        "codabar_reader"    // Codabar
                    ]
                },
                locate: true, // Enable localization of barcodes
                multiple: false, // Stop after first barcode is detected
                debug: {
                    showCanvas: true, // Show the canvas overlay
                    showPatches: true,
                    showFoundPatches: true,
                    showSkeleton: true,
                    showLabels: true,
                    showPatchLabels: false,
                    showRemainingPatchLabels: false,
                    boxFromPatches: {
                        showTransformed: true,
                        showTransformedBox: true,
                        showBB: true
                    }
                }
            }, function(err) {
                if (err) {
                    console.error("Quagga initialization error:", err);
                    alert("Error initializing the scanner: " + err);
                    startButton.disabled = false;
                    debugMessage.textContent = "Scanner initialization failed.";
                    return;
                }
                Quagga.start();
                debugMessage.textContent = "Scanning for barcodes...";
                console.log("QuaggaJS initialized successfully.");
            });

            // Event handler when a barcode is detected
            Quagga.onDetected(function(data) {
                const code = data.codeResult.code;
                console.log("Barcode detected: " + code);
                alert("Barcode detected: " + code);
                Quagga.stop(); // Stop the scanner after detection
                startButton.disabled = false; // Re-enable the button
                debugMessage.textContent = "Barcode detected: " + code;
            });

            // Event handler for processed frames (for debugging)
            Quagga.onProcessed(function(result) {
                if (result) {
                    // Clear the overlay canvas
                    overlayContext.clearRect(0, 0, overlay.width, overlay.height);

                    // Draw scan lines for visual feedback
                    drawScanLines();

                    // Draw bounding boxes around detected barcodes
                    if (result.boxes) {
                        result.boxes.forEach(function(box) {
                            overlayContext.strokeStyle = "rgba(0, 255, 0, 0.5)";
                            overlayContext.lineWidth = 2;
                            overlayContext.beginPath();
                            box.forEach(function(point, index) {
                                if (index === 0) {
                                    overlayContext.moveTo(point.x, point.y);
                                } else {
                                    overlayContext.lineTo(point.x, point.y);
                                }
                            });
                            overlayContext.closePath();
                            overlayContext.stroke();
                        });
                    }

                    // Highlight the currently detected barcode
                    if (result.box) {
                        overlayContext.strokeStyle = "rgba(255, 0, 0, 0.8)";
                        overlayContext.lineWidth = 3;
                        overlayContext.beginPath();
                        result.box.forEach(function(point, index) {
                            if (index === 0) {
                                overlayContext.moveTo(point.x, point.y);
                            } else {
                                overlayContext.lineTo(point.x, point.y);
                            }
                        });
                        overlayContext.closePath();
                        overlayContext.stroke();
                    }

                    // Display the decoded barcode value
                    if (result.codeResult && result.codeResult.code) {
                        overlayContext.font = "18px Arial";
                        overlayContext.fillStyle = "rgba(255, 0, 0, 0.8)";
                        overlayContext.fillText(result.codeResult.code, result.box[0].x, result.box[0].y - 10);
                    }
                }
            });

            // Handle video play event to resize the overlay
            video.addEventListener('play', function() {
                resizeOverlay();
            });

            // Handle window resize to adjust overlay size
            window.addEventListener('resize', function() {
                if (!video.paused && !video.ended) {
                    resizeOverlay();
                }
            });
        }

        // Event listener for the Start Scanner button
        startButton.addEventListener('click', function() {
            // Disable the button to prevent multiple initializations
            startButton.disabled = true;
            debugMessage.textContent = "Requesting camera access...";

            // Request camera access and start video stream
            navigator.mediaDevices.getUserMedia({ video: { facingMode: "environment" } })
                .then(function(stream) {
                    video.srcObject = stream;
                    video.setAttribute("playsinline", true); // Required for iOS Safari
                    video.play();
                    console.log("Camera stream started.");
                    debugMessage.textContent = "Initializing scanner...";
                    initializeQuagga();
                })
                .catch(function(err) {
                    console.error("Camera access error:", err);
                    alert("Unable to access the camera: " + err);
                    startButton.disabled = false;
                    debugMessage.textContent = "Camera access denied.";
                });
        });
    </script>
</body>
</html>
