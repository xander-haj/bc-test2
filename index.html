<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Android Barcode Scanner with QuaggaJS</title>
    <!-- QuaggaJS Library -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/quagga/0.12.1/quagga.min.js"></script>
    <style>
        /* Container styling to maintain 4:3 aspect ratio */
        #scanner-container {
            position: relative;
            width: 100%;
            max-width: 480px; /* Adjust as needed */
            margin: 20px auto;
            padding-top: 75%; /* 4:3 Aspect Ratio (height/width = 0.75) */
            background: #000;
            overflow: hidden;
        }
        /* Overlay canvas positioning */
        #overlay {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none; /* Allow clicks to pass through */
        }
        /* Start Scanner button styling */
        #start-button {
            display: block;
            margin: 20px auto;
            padding: 10px 20px;
            font-size: 16px;
            background-color: #4CAF50;
            color: white;
            border: none;
            border-radius: 5px;
        }
        /* Styling for debugging messages */
        #debug-message {
            text-align: center;
            margin-top: 10px;
            font-family: Arial, sans-serif;
            color: #333;
        }
    </style>
</head>
<body>
    <!-- Start Scanner Button -->
    <button id="start-button">Start Scanner</button>

    <!-- Scanner Container with Overlay -->
    <div id="scanner-container">
        <canvas id="overlay"></canvas>
    </div>

    <!-- Debug Message -->
    <div id="debug-message"></div>

    <script>
        // Reference to the Start Scanner button and debug message div
        const startButton = document.getElementById('start-button');
        const debugMessage = document.getElementById('debug-message');

        // Event listener for the Start Scanner button
        startButton.addEventListener('click', function() {
            // Disable the button to prevent multiple initializations
            startButton.disabled = true;
            debugMessage.textContent = "Initializing scanner...";

            // Initialize QuaggaJS
            Quagga.init({
                inputStream: {
                    name: "Live",
                    type: "LiveStream",
                    target: document.querySelector('#scanner-container'), // Container to append video
                    constraints: {
                        facingMode: "environment", // Use rear camera
                        width: { ideal: 640 },
                        height: { ideal: 480 }
                    }
                },
                decoder: {
                    readers: [
                        "upc_reader",       // UPC-A, UPC-E
                        "ean_reader",       // EAN-13, EAN-8
                        "code_128_reader",  // Code 128
                        "code_39_reader",   // Code 39
                        "code_93_reader",   // Code 93
                        "codabar_reader"    // Codabar
                    ]
                },
                locate: true, // Enable localization of barcodes
                locate: true,
                multiple: false, // Stop after first barcode is detected
                area: {
                    top: "30%",    // Top offset
                    right: "30%",  // Right offset
                    left: "30%",   // Left offset
                    bottom: "30%"  // Bottom offset
                },
                debug: {
                    showCanvas: true, // Show the canvas overlay
                    showPatches: false,
                    showFoundPatches: false,
                    showSkeleton: true, // Show skeleton for better debugging
                    showLabels: true,
                    showPatchLabels: false,
                    showRemainingPatchLabels: false,
                    boxFromPatches: {
                        showTransformed: false,
                        showTransformedBox: false,
                        showBB: false
                    }
                }
            }, function(err) {
                if (err) {
                    console.error(err);
                    alert("Error initializing the scanner: " + err);
                    startButton.disabled = false;
                    debugMessage.textContent = "Scanner initialization failed.";
                    return;
                }
                // Start QuaggaJS
                Quagga.start();
                debugMessage.textContent = "Scanning for barcodes...";
                console.log("QuaggaJS initialized successfully.");
            });

            // Event handler when a barcode is detected
            Quagga.onDetected(function(data) {
                const code = data.codeResult.code;
                console.log("Barcode detected: " + code);
                alert("Barcode detected: " + code);
                Quagga.stop(); // Stop the scanner after detection
                startButton.disabled = false; // Re-enable the button
                debugMessage.textContent = "Barcode detected: " + code;
            });

            // Handle processed frames for debugging and overlay
            Quagga.onProcessed(function(result) {
                const overlay = document.getElementById('overlay');
                const context = overlay.getContext('2d');

                if (result) {
                    // Clear previous drawings
                    context.clearRect(0, 0, overlay.width, overlay.height);

                    // Draw detected boxes
                    if (result.boxes) {
                        result.boxes.forEach(function(box) {
                            context.strokeStyle = "#00FF00"; // Green for all boxes
                            context.lineWidth = 2;
                            context.beginPath();
                            box.forEach(function(point, index) {
                                if (index === 0) {
                                    context.moveTo(point.x, point.y);
                                } else {
                                    context.lineTo(point.x, point.y);
                                }
                            });
                            context.closePath();
                            context.stroke();
                        });
                    }

                    // Highlight the currently detected box
                    if (result.box) {
                        context.strokeStyle = "#FF0000"; // Red for the current box
                        context.lineWidth = 2;
                        context.beginPath();
                        result.box.forEach(function(point, index) {
                            if (index === 0) {
                                context.moveTo(point.x, point.y);
                            } else {
                                context.lineTo(point.x, point.y);
                            }
                        });
                        context.closePath();
                        context.stroke();
                    }

                    // If a code is detected, display it
                    if (result.codeResult && result.codeResult.code) {
                        context.font = "18px Arial";
                        context.fillStyle = "#FF0000"; // Red text
                        context.fillText(result.codeResult.code, result.box[0].x, result.box[0].y - 10);
                    }
                }
            });

            // Resize the overlay canvas to match the video stream
            function resizeOverlay() {
                const overlay = document.getElementById('overlay');
                const scannerContainer = document.getElementById('scanner-container');
                overlay.width = scannerContainer.clientWidth;
                overlay.height = scannerContainer.clientHeight;
            }

            // Initial resize
            resizeOverlay();

            // Resize on window resize
            window.addEventListener('resize', resizeOverlay);
        });
    </script>
</body>
</html>
